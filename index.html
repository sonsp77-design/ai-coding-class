<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIì½”ë”© êµì‹¤ ì‹ ì²­</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #0056b3; --bg: #f4f7f9; --danger: #dc3545; --success: #28a745; --info: #17a2b8; --secondary: #6c757d; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; box-sizing: border-box; }
        .container { background: white; width: 100%; max-width: 900px; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); position: relative; }
        .admin-link { position: absolute; top: 15px; right: 15px; font-size: 13px; color: #999; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 5px; padding: 5px; z-index: 10; }
        .admin-link:hover { color: var(--primary); }
        .header { text-align: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .header h2 { font-size: 1.5rem; margin: 0 0 5px 0; word-break: keep-all; } 
        .step { display: none; animation: fadeIn 0.4s; }
        .step.active { display: block; }
        .admin-panel { display: none; background: #fff; padding-top: 10px; }
        .admin-panel.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; width: 100%; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-light { background: #eee; color: #333; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 8px 12px; font-size: 13px; width: auto; }
        
        .calendar-wrapper { border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff; margin-bottom: 10px; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-header button { padding: 5px 8px; font-size: 12px; border: 1px solid #ddd; border-radius: 5px; background: none; }
        .cal-header h3 { font-size: 16px; margin: 0; color: var(--primary); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .cal-day-name { font-size: 12px; padding-bottom: 5px; font-weight: bold; color: #666; }
        .cal-day-name:nth-child(1) { color: #dc3545; } 
        .cal-day-name:nth-child(7) { color: #0056b3; } 
        .cal-date { padding: 2px; border-radius: 4px; font-size: 13px; cursor: pointer; border: 1px solid #f0f0f0; height: 50px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; }
        .cal-date span { margin-top: 3px; font-weight: bold; }
        .cal-status-text { font-size: 9px; margin-top: auto; margin-bottom: 2px; line-height: 1.1; word-break: keep-all; letter-spacing: -0.5px; }
        .cal-date:hover:not(.disabled):not(.occupied) { background-color: #e3f2fd; border-color: var(--primary); }
        .cal-date.disabled { background-color: #f8f9fa; color: #ccc; cursor: not-allowed; } 
        .cal-date.occupied { background-color: #dc3545; color: white; border: 1px solid #c82333; } 
        .cal-date.selected { background-color: #28a745; color: white; border: 1px solid #218838; } 
        .cal-date.admin-selected { background-color: #ffc107; color: #000; border: 2px solid #ff9800; font-weight: bold; }
        .cal-legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; font-size: 11px; justify-content: center; }
        .dot { width: 10px; height: 10px; border-radius: 2px; display: inline-block; margin-right: 3px; }

        .styled-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .styled-table thead tr { background-color: #0056b3; color: #ffffff; text-align: center; }
        .styled-table th, .styled-table td { padding: 8px 5px; border-bottom: 1px solid #dddddd; text-align: center; vertical-align: middle; }
        
        .admin-section { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
        .blocked-tag { display: inline-flex; align-items: center; background: #ffebee; color: #c62828; padding: 3px 10px; border-radius: 15px; margin: 3px; font-size: 12px; }
        .blocked-tag button { background: none; border: none; color: #c62828; cursor: pointer; margin-left: 5px; font-weight: bold; }
        
        .tab-menu { display: flex; gap: 5px; margin-bottom: 15px; background: #f1f3f5; border-radius: 8px; padding: 5px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 8px; font-size: 13px; color: #666; cursor: pointer; border:none; background:none; text-align:center; white-space: nowrap; }
        .tab-btn.active { background: white; color: var(--primary); font-weight: bold; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-open { background: #d4edda; color: #155724; }
        .status-closed { background: #f8d7da; color: #721c24; }
        .input-row { display: flex; gap: 5px; align-items: center; }
        .input-row input { flex: 1; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: white; padding: 20px; border-radius: 10px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 5px; border: none; cursor: pointer; font-size: 14px; font-weight:bold;}
        .modal-btn.confirm { background: var(--primary); color: white; }
        .modal-btn.cancel { background: #eee; color: #333; }
        .modal-btn.danger { background: var(--danger); color: white; }
        
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 99999; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 18px; font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">ë°ì´í„° ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>

<div class="container">
    <a onclick="openAdminAuth()" class="admin-link">âš™ï¸ ê´€ë¦¬ì</a>

    <div class="header">
        <h2 id="mainTitle">2026 AIì½”ë”© êµì‹¤ ì‹ ì²­</h2>
        <p id="subTitle">ì „ë¼ë‚¨ë„êµìœ¡ì²­ì°½ì˜ìœµí•©êµìœ¡ì›</p>
        <div id="statusIndicator" style="margin-top:10px;"></div>
    </div>

    <div id="userMode">
        <div id="userStep1" class="step active">
            <h3>1ë‹¨ê³„: ì‹ ì²­ì ì •ë³´</h3>
            <div class="form-group">
                <label>ì†Œì†</label>
                <input type="text" id="uAff" placeholder="í•™êµëª…(â—‹â—‹ì´ˆë“±í•™êµ, â—‹â—‹ì¤‘í•™êµ) ì…ë ¥">
            </div>
            <div class="form-group">
                <label>ì§ìœ„</label>
                <input type="text" id="uPos" value="êµì‚¬" readonly>
            </div>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="uName">
            </div>
            <div class="form-group">
                <label>ì—°ë½ì²˜</label>
                <input type="tel" id="uTel" placeholder="010-0000-0000" maxlength="13" oninput="autoHyphen(this)">
            </div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="checkMyStatus()">ğŸ“‹ ë‚´ì—­ í™•ì¸</button>
                <button class="btn btn-primary" onclick="toUserStep2()">ì‹ ì²­í•˜ê¸° (ë‹¤ìŒ)</button>
            </div>
        </div>

        <div id="userStep2" class="step">
            <h3>2ë‹¨ê³„: êµìœ¡ ì¼ì • ì„ íƒ</h3>
            <div class="form-group">
                <label>êµìœ¡ í¬ë§ ë‚ ì§œ ì„ íƒ</label>
                <div class="calendar-wrapper">
                    <div class="cal-header">
                        <button onclick="prevMonth()">&lt; ì´ì „</button>
                        <h3 id="calMonthYear">2026ë…„ 1ì›”</h3>
                        <button onclick="next()">ë‹¤ìŒ &gt;</button>
                    </div>
                    <div class="cal-grid" id="calGridHeader">
                        <div class="cal-day-name">ì¼</div><div class="cal-day-name">ì›”</div><div class="cal-day-name">í™”</div>
                        <div class="cal-day-name">ìˆ˜</div><div class="cal-day-name">ëª©</div><div class="cal-day-name">ê¸ˆ</div><div class="cal-day-name">í† </div>
                    </div>
                    <div class="cal-grid" id="calGrid"></div>
                    <div class="cal-legend">
                        <div class="legend-item"><span class="dot" style="background:#28a745;"></span>ë‚´ ì„ íƒ</div>
                        <div class="legend-item"><span class="dot" style="background:#dc3545;"></span>ì‹ ì²­ì ‘ìˆ˜ ì™„ë£Œ</div>
                        <div class="legend-item"><span class="dot" style="background:#f0f0f0; border:1px solid #ccc;"></span>ì œì™¸</div>
                    </div>
                </div>
                <input type="hidden" id="uDate">
                <p id="selectedDateDisplay" style="text-align:center; font-weight:bold; color:#0056b3; margin-top:5px; height:20px; font-size:14px;"></p>
            </div>

            <div class="form-group">
                <label>êµìœ¡ ì‹œê°„</label>
                <div style="display:flex; gap:10px; padding: 10px 0;">
                    <label style="font-weight:normal; flex:1; background:#f8f9fa; padding:10px; border-radius:5px; text-align:center; border:1px solid #ddd;"><input type="radio" name="uTime" value="ì˜¤ì „(4ì‹œê°„)"> ì˜¤ì „(4ì‹œê°„)</label>
                    <label style="font-weight:normal; flex:1; background:#f8f9fa; padding:10px; border-radius:5px; text-align:center; border:1px solid #ddd;"><input type="radio" name="uTime" value="ì¢…ì¼(6ì‹œê°„)"> ì¢…ì¼(6ì‹œê°„)</label>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="toUserStep1()">ì´ì „</button>
                <button class="btn btn-primary" id="finalSubmit" onclick="checkBeforeSubmit()">ì‹ ì²­ ì™„ë£Œ</button>
            </div>
        </div>

        <div id="userStep3" class="step">
            <div style="text-align:center; padding: 20px 0;">
                <h2 style="color:green; margin-bottom: 10px;">ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                <p>ì…ë ¥í•˜ì‹  ì •ë³´ëŠ” ê´€ë¦¬ìì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div id="resultSummary" style="background:#f1f8ff; padding:20px; border-radius:8px; text-align:left; margin:20px 0; font-size:14px;"></div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="resetForm()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    <button class="btn btn-primary" onclick="editAndResubmit()">ì‹ ì²­ ìˆ˜ì •í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="adminMode" class="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:var(--primary);">ê´€ë¦¬ì í˜ì´ì§€</h3>
            <div>
                <button class="btn btn-info btn-sm" onclick="refreshAdminData()">ğŸ”„ í˜„í–‰í™”</button>
                <button class="btn btn-secondary btn-sm" onclick="exitAdmin()">ë‚˜ê°€ê¸°</button>
            </div>
        </div>

        <div class="admin-section" style="border-left: 5px solid var(--info);">
            <h4>ğŸ·ï¸ íƒ€ì´í‹€ ë° ê¸°ê´€ ì„¤ì •</h4>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <input type="text" id="adminMainTitle" placeholder="ë©”ì¸ íƒ€ì´í‹€">
                <input type="text" id="adminSubTitle" placeholder="ì„œë¸Œ íƒ€ì´í‹€">
                <button class="btn btn-primary btn-sm" style="width:100%" onclick="adminSaveTitleInfo()">íƒ€ì´í‹€ ì •ë³´ ì €ì¥</button>
            </div>
        </div>

        <div class="admin-section" style="border-left: 5px solid var(--primary);">
            <h4>ğŸ“¢ ì‹ ì²­ ê¸°ê°„ ê´€ë¦¬</h4>
            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchAdminTab('period')">ê¸°ê°„ì„¤ì •</button>
                <button class="tab-btn" onclick="switchAdminTab('extend')">ì—°ì¥</button>
                <button class="tab-btn" onclick="switchAdminTab('close')">ë§ˆê°</button>
            </div>
            <div id="tab-period" class="admin-tab-content">
                <label style="font-size:13px; margin-bottom:5px;">ì‹ ì²­ ì‹œì‘ ~ ì¢…ë£Œ</label>
                <div class="input-row">
                    <input type="datetime-local" id="adminAppStart">
                    <span>~</span>
                    <input type="datetime-local" id="adminAppEnd">
                </div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn btn-primary btn-sm" style="flex:1" onclick="adminSaveAppRange()">ì €ì¥</button>
                    <button class="btn btn-secondary btn-sm" style="flex:0 0 70px;" onclick="adminResetAppRange()">ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div id="tab-extend" class="admin-tab-content" style="display:none;">
                <label style="font-size:13px; margin-bottom:5px;">ì¢…ë£Œì¼ì‹œ ì—°ì¥</label>
                <div class="input-row">
                    <input type="datetime-local" id="adminExtendEnd">
                    <button class="btn btn-success btn-sm" style="flex:0 0 70px;" onclick="adminExtendApp()">ì ìš©</button>
                </div>
            </div>
            <div id="tab-close" class="admin-tab-content" style="display:none;">
                <label style="font-size:13px; margin-bottom:10px; display:block;">ìƒíƒœ: <span id="forceStatusText"></span></label>
                <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <label style="font-size:12px; color:#666;">ì‹ ì²­ ì œí•œ ì¸ì› (0=ë¬´ì œí•œ)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="adminAppLimit" placeholder="ìˆ«ì" style="flex:1;">
                        <button class="btn btn-primary btn-sm" onclick="adminSaveAppLimit()">ì €ì¥</button>
                    </div>
                </div>
                <button id="btnForceClose" class="btn btn-danger btn-sm" style="width:100%" onclick="toggleForceClose(true)">âš ï¸ ê°•ì œ ë§ˆê°</button>
                <button id="btnForceOpen" class="btn btn-success btn-sm" style="width:100%; display:none;" onclick="toggleForceClose(false)">ğŸ”„ ë§ˆê° í•´ì œ</button>
            </div>
        </div>

        <div class="admin-section">
            <h4>ğŸ“… êµìœ¡ ê¸°ê°„ ì„¤ì •</h4>
            <div class="input-row">
                <input type="date" id="adminEduStart">
                <span>~</span>
                <input type="date" id="adminEduEnd">
                <button class="btn btn-primary btn-sm" style="flex:0 0 60px;" onclick="adminSaveEduRange()">ì €ì¥</button>
            </div>
        </div>

        <div class="admin-section">
            <h4>ğŸš« êµìœ¡ ì œì™¸ì¼(ê³µíœ´ì¼) ì„¤ì •</h4>
            <div class="calendar-wrapper" style="margin-bottom:10px;">
                <div class="cal-header">
                    <button onclick="prevAdminCal()">&lt; ì´ì „</button>
                    <h3 id="adminCalMonthYear" style="font-size:15px; color:#333;">2026ë…„ 1ì›”</h3>
                    <button onclick="nextAdminCal()">ë‹¤ìŒ &gt;</button>
                </div>
                <div class="cal-grid" id="adminCalGrid"></div>
                <div class="cal-legend">
                    <div class="legend-item"><span class="dot" style="background:#ffc107; border:1px solid #ff9800;"></span>ì„ íƒë¨(ì°¨ë‹¨ì˜ˆì •)</div>
                    <div class="legend-item"><span class="dot" style="background:#f0f0f0;"></span>ê¸°ì¡´ì°¨ë‹¨</div>
                </div>
            </div>
            <button class="btn btn-danger btn-sm" style="width:100%; margin-bottom:15px;" onclick="adminBlockSelectedDates()">ì„ íƒí•œ ë‚ ì§œ ì°¨ë‹¨í•˜ê¸°</button>

            <label style="font-size:13px; margin-bottom:5px; display:block;">ì—°ë„ë³„ ê³µíœ´ì¼ ì¼ê´„ ë“±ë¡</label>
            <div style="display:flex; gap:5px; margin-bottom:10px; align-items:center;">
                <select id="holidayYear" style="flex:1;"></select>
                <button class="btn btn-secondary btn-sm" style="flex:2; background:#6c757d;" onclick="adminAddHolidays()">ê³µíœ´ì¼ ë“±ë¡</button>
            </div>
            
            <button class="btn btn-secondary btn-sm" style="width:100%; background:#6c757d;" onclick="adminClearAllBlocks()">ğŸ—‘ï¸ ì°¨ë‹¨ ì¼ê´„ í•´ì œ(ì´ˆê¸°í™”)</button>
            
            <div id="adminBlockedList" style="margin-top:10px;"></div>
        </div>

        <div class="admin-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">ğŸ“ ì‹ ì²­ í˜„í™© (<span id="adminCount">0</span> / <span id="adminLimitDisplay">âˆ</span>)</h4>
                <div>
                    <button class="btn btn-danger btn-sm" onclick="adminDeleteSelected()">ì„ íƒ ì‚­ì œ</button>
                    <button class="btn btn-primary btn-sm" onclick="downloadExcel()">ì—‘ì…€</button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table id="adminTable" class="styled-table">
                    <thead>
                        <tr>
                            <th style="width:30px;"><input type="checkbox" onclick="toggleAllChecks(this)"></th>
                            <th>No</th>
                            <th>ì ‘ìˆ˜ì¼ì‹œ</th>
                            <th>ì´ë¦„</th>
                            <th>ì†Œì†</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>ì‹ ì²­ ì¼ì •</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div style="text-align:center; margin-top:30px; padding-top:20px; border-top:1px dashed #ddd;">
            <button class="btn btn-light" style="width:auto; border:1px solid #ddd;" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                â¬†ï¸ ë§¨ ìœ„ë¡œ
            </button>
        </div>
    </div>
</div>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0; color:#d9534f;">í™•ì¸í•´ì£¼ì„¸ìš”</h3>
        <p id="modalMsg" style="line-height:1.5; word-break: keep-all;"></p>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="modal-btn confirm" onclick="processSubmission()">ì‹ ì²­ ì™„ë£Œ</button>
        </div>
    </div>
</div>
<div id="statusModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--info);">ğŸ“‹ ì‹ ì²­ ì •ë³´ í™•ì¸</h3>
        <div id="statusContent" style="text-align:left; font-size:14px; margin:20px 0; background:#f8f9fa; padding:15px; border-radius:5px;"></div>
        <div class="modal-buttons">
            <button class="modal-btn confirm" onclick="editFromStatus()">âœï¸ ìˆ˜ì •</button>
            <button class="modal-btn danger" onclick="cancelMyApplication()">ğŸ—‘ï¸ ì‹ ì²­ ì·¨ì†Œ</button>
            <button class="modal-btn cancel" onclick="closeStatusModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    // â˜…â˜…â˜… Supabase ì„¤ì • (ë³€ìˆ˜ëª… dbë¡œ ìˆ˜ì • ì™„ë£Œ!) â˜…â˜…â˜…
    const SUPABASE_URL = "https://prlonmttupmpagbqvecj.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_X7tSiDkiiJMbDatMdVcePA_l_WzPyiM";
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const ADMIN_PASSWORD = "1416"; 

    // [DATA] ê³µíœ´ì¼ DB
    const HOLIDAY_DB = {
        "2025": { "2025-01-01": "ì‹ ì •", "2025-01-28": "ì„¤ë‚ ", "2025-01-29": "ì„¤ë‚ ", "2025-01-30": "ì„¤ë‚ ", "2025-03-01": "ì‚¼ì¼ì ˆ", "2025-03-03": "ëŒ€ì²´ê³µíœ´ì¼", "2025-05-05": "ì–´ë¦°ì´ë‚ ", "2025-05-06": "ëŒ€ì²´ê³µíœ´ì¼", "2025-06-06": "í˜„ì¶©ì¼", "2025-08-15": "ê´‘ë³µì ˆ", "2025-10-03": "ê°œì²œì ˆ", "2025-10-05": "ì¶”ì„", "2025-10-06": "ì¶”ì„", "2025-10-07": "ì¶”ì„", "2025-10-08": "ëŒ€ì²´ê³µíœ´ì¼", "2025-10-09": "í•œê¸€ë‚ ", "2025-12-25": "ì„±íƒ„ì ˆ" },
        "2026": { "2026-01-01": "ì‹ ì •", "2026-02-16": "ì„¤ë‚ ", "2026-02-17": "ì„¤ë‚ ", "2026-02-18": "ì„¤ë‚ ", "2026-03-01": "ì‚¼ì¼ì ˆ", "2026-03-02": "ëŒ€ì²´ê³µíœ´ì¼", "2026-05-05": "ì–´ë¦°ì´ë‚ ", "2026-05-24": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2026-05-25": "ëŒ€ì²´ê³µíœ´ì¼", "2026-06-06": "í˜„ì¶©ì¼", "2026-08-15": "ê´‘ë³µì ˆ", "2026-09-24": "ì¶”ì„", "2026-09-25": "ì¶”ì„", "2026-09-26": "ì¶”ì„", "2026-10-03": "ê°œì²œì ˆ", "2026-10-09": "í•œê¸€ë‚ ", "2026-12-25": "ì„±íƒ„ì ˆ" },
        "2027": { "2027-01-01": "ì‹ ì •", "2027-02-06": "ì„¤ë‚ ", "2027-02-07": "ì„¤ë‚ ", "2027-02-08": "ì„¤ë‚ ", "2027-03-01": "ì‚¼ì¼ì ˆ", "2027-05-05": "ì–´ë¦°ì´ë‚ ", "2027-05-13": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2027-06-06": "í˜„ì¶©ì¼", "2027-08-15": "ê´‘ë³µì ˆ", "2027-08-16": "ëŒ€ì²´ê³µíœ´ì¼", "2027-09-14": "ì¶”ì„", "2027-09-15": "ì¶”ì„", "2027-09-16": "ì¶”ì„", "2027-10-03": "ê°œì²œì ˆ", "2027-10-04": "ëŒ€ì²´ê³µíœ´ì¼", "2027-10-09": "í•œê¸€ë‚ ", "2027-12-25": "ì„±íƒ„ì ˆ" },
        "2028": { "2028-01-01": "ì‹ ì •", "2028-01-26": "ì„¤ë‚ ", "2028-01-27": "ì„¤ë‚ ", "2028-01-28": "ì„¤ë‚ ", "2028-03-01": "ì‚¼ì¼ì ˆ", "2028-05-02": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2028-05-05": "ì–´ë¦°ì´ë‚ ", "2028-06-06": "í˜„ì¶©ì¼", "2028-08-15": "ê´‘ë³µì ˆ", "2028-10-02": "ì¶”ì„", "2028-10-03": "ê°œì²œì ˆ", "2028-10-04": "ì¶”ì„", "2028-10-05": "ëŒ€ì²´ê³µíœ´ì¼", "2028-10-09": "í•œê¸€ë‚ ", "2028-12-25": "ì„±íƒ„ì ˆ" },
        "2029": { "2029-01-01": "ì‹ ì •", "2029-02-12": "ì„¤ë‚ ", "2029-02-13": "ì„¤ë‚ ", "2029-02-14": "ì„¤ë‚ ", "2029-03-01": "ì‚¼ì¼ì ˆ", "2029-05-05": "ì–´ë¦°ì´ë‚ ", "2029-05-07": "ëŒ€ì²´ê³µíœ´ì¼", "2029-05-20": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2029-06-06": "í˜„ì¶©ì¼", "2029-08-15": "ê´‘ë³µì ˆ", "2029-09-21": "ì¶”ì„", "2029-09-22": "ì¶”ì„", "2029-09-23": "ì¶”ì„", "2029-09-24": "ëŒ€ì²´ê³µíœ´ì¼", "2029-10-03": "ê°œì²œì ˆ", "2029-10-09": "í•œê¸€ë‚ ", "2029-12-25": "ì„±íƒ„ì ˆ" },
        "2030": { "2030-01-01": "ì‹ ì •", "2030-02-02": "ì„¤ë‚ ", "2030-02-03": "ì„¤ë‚ ", "2030-02-04": "ì„¤ë‚ ", "2030-02-05": "ëŒ€ì²´ê³µíœ´ì¼", "2030-03-01": "ì‚¼ì¼ì ˆ", "2030-05-05": "ì–´ë¦°ì´ë‚ ", "2030-05-06": "ëŒ€ì²´ê³µíœ´ì¼", "2030-05-09": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2030-06-06": "í˜„ì¶©ì¼", "2030-08-15": "ê´‘ë³µì ˆ", "2030-09-11": "ì¶”ì„", "2030-09-12": "ì¶”ì„", "2030-09-13": "ì¶”ì„", "2030-10-03": "ê°œì²œì ˆ", "2030-10-09": "í•œê¸€ë‚ ", "2030-12-25": "ì„±íƒ„ì ˆ" }
    };

    let blockedDates = []; 
    let occupiedDates = [];
    let eduRange = { start: "", end: "" };
    let appRange = { start: "", end: "" };  
    let isForceClosed = false;              
    let appLimit = 0;
    let currentPriorities = []; 
    let adminToken = ""; 
    let adminDataCache = [];
    let currentUserData = {};

    let currentYear = 2026;
    let currentMonth = 0; 
    let adminCalYear = 2026;
    let adminCalMonth = 0;
    let adminSelectedDates = []; 

    window.onload = function() { 
        const now = new Date();
        if(now.getFullYear() < 2026) { currentYear = 2026; currentMonth = 0; }
        else { currentYear = now.getFullYear(); currentMonth = now.getMonth(); }
        adminCalYear = currentYear; adminCalMonth = currentMonth;
        
        const holidaySelect = document.getElementById('holidayYear');
        holidaySelect.innerHTML = "";
        Object.keys(HOLIDAY_DB).forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y + "ë…„";
            if(y == currentYear) opt.selected = true;
            holidaySelect.appendChild(opt);
        });
        fetchSettings(); 
    };

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

    async function fetchSettings() {
        try {
            const { data: config } = await db.from('config').select('*').eq('id', 1).single();
            if (config) {
                eduRange = { start: config.edu_start || "", end: config.edu_end || "" };
                appRange = { 
                    start: config.app_start ? config.app_start.replace(' ', 'T').substring(0, 16) : "", 
                    end: config.app_end ? config.app_end.replace(' ', 'T').substring(0, 16) : "" 
                };
                isForceClosed = config.is_force_closed;
                appLimit = config.app_limit;

                document.getElementById('mainTitle').innerText = config.main_title;
                document.getElementById('subTitle').innerText = config.sub_title;
                document.getElementById('adminMainTitle').value = config.main_title;
                document.getElementById('adminSubTitle').value = config.sub_title;
                document.getElementById('adminAppLimit').value = appLimit;
                document.getElementById('adminLimitDisplay').innerText = (appLimit > 0) ? appLimit : "âˆ";
            }

            const { data: blocks } = await db.from('blocked_dates').select('blocked_date');
            if (blocks) blockedDates = blocks.map(b => b.blocked_date);

            const { data: apps } = await db.from('applications').select('schedule_date');
            if (apps) {
                occupiedDates = apps.map(a => a.schedule_date);
                document.getElementById('adminCount').innerText = apps.length;
            }

            updateStatusIndicator();
            renderCalendar(currentYear, currentMonth);
            renderAdminCalendar(); 
        } catch (error) {
            console.error("ì´ˆê¸° ë¡œë”© ì˜¤ë¥˜:", error);
        }
    }

    function updateStatusIndicator() {
        const div = document.getElementById('statusIndicator');
        const now = new Date(); 
        if (isForceClosed) { div.innerHTML = '<span class="status-badge status-closed">â›” ì‹ ì²­ ë§ˆê° (ì¢…ë£Œ)</span>'; return; }
        if (appRange.start && appRange.end) {
            const start = new Date(appRange.start);
            const end = new Date(appRange.end);
            if (now < start) div.innerHTML = `<span class="status-badge" style="background:#eee; color:#555;">â³ ì‹ ì²­ ëŒ€ê¸° (${appRange.start.replace('T',' ')}~)</span>`;
            else if (now > end) div.innerHTML = '<span class="status-badge status-closed">â›” ì‹ ì²­ ê¸°ê°„ ì¢…ë£Œ</span>';
            else div.innerHTML = `<span class="status-badge status-open">âœ… ì‹ ì²­ ì§„í–‰ ì¤‘ (~${appRange.end.replace('T',' ')})</span>`;
        } else div.innerHTML = '';
    }

    function checkAppValidity() {
        if (isForceClosed) { alert("ì‹ ì²­ì´ ì¡°ê¸° ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤."); return false; }
        const now = new Date();
        if (appRange.start && appRange.end) {
            const start = new Date(appRange.start);
            const end = new Date(appRange.end);
            if (now < start) { alert("ì•„ì§ ì‹ ì²­ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤."); return false; }
            if (now > end) { alert("ì‹ ì²­ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); return false; }
        }
        return true;
    }

    function renderCalendar(year, month) {
        const grid = document.getElementById('calGrid');
        grid.innerHTML = "";
        document.getElementById('calMonthYear').innerText = `${year}ë…„ ${month + 1}ì›”`;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate(); 
        
        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const dayOfWeek = dateObj.getDay();
            const monthStr = (month + 1).toString().padStart(2, '0'); 
            const dayStr = d.toString().padStart(2, '0');
            const fullDateStr = `${year}-${monthStr}-${dayStr}`;
            const cell = document.createElement('div'); cell.className = 'cal-date';
            
            let html = `<span>${d}</span>`; 
            let isBlocked = false; let isOccupied = false;
            let holidayName = "ì œì™¸";
            
            if(HOLIDAY_DB[year] && HOLIDAY_DB[year][fullDateStr]) holidayName = HOLIDAY_DB[year][fullDateStr];

            if(blockedDates.includes(fullDateStr)) { cell.classList.add('disabled'); html += `<div class="cal-status-text" style="color:#888;">${holidayName}</div>`; isBlocked = true; }
            else if(occupiedDates.includes(fullDateStr)) { cell.classList.add('occupied'); html += `<div class="cal-status-text">ì‹ ì²­ì ‘ìˆ˜ ì™„ë£Œ</div>`; isOccupied = true; }
            else if(eduRange.start && eduRange.end && (fullDateStr < eduRange.start || fullDateStr > eduRange.end)) { cell.classList.add('disabled'); isBlocked = true; }
            else if(dayOfWeek === 0 || dayOfWeek === 6) { cell.classList.add('disabled'); isBlocked = true; }
            else if(document.getElementById('uDate').value === fullDateStr) { cell.classList.add('selected'); }
            
            cell.innerHTML = html;
            if(!isBlocked && !isOccupied) { cell.onclick = function() { selectDate(fullDateStr); }; }
            grid.appendChild(cell);
        }
    }
    
    function prevMonth() { currentMonth--; if(currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(currentYear, currentMonth); }
    function next() { currentMonth++; if(currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(currentYear, currentMonth); }
    function selectDate(dateStr) { document.getElementById('uDate').value = dateStr; document.getElementById('selectedDateDisplay').innerText = `ì„ íƒí•œ ë‚ ì§œ: ${dateStr}`; renderCalendar(currentYear, currentMonth); }

    function checkBeforeSubmit() {
        if (!checkAppValidity()) return;
        const date = document.getElementById('uDate').value; const time = document.querySelector('input[name="uTime"]:checked')?.value;
        if(!date || !time) return alert("ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        currentPriorities = [{date: date, time: time}];
        if(confirm("ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) processSubmission();
    }
    function closeModal() { document.getElementById('customModal').classList.remove('show'); }
    
    async function processSubmission() {
        closeModal();
        showLoading(true);
        const data = { aff: document.getElementById('uAff').value, pos: document.getElementById('uPos').value, name: document.getElementById('uName').value, tel: document.getElementById('uTel').value };
        const p = currentPriorities[0];

        try {
            const { count } = await db.from('applications').select('*', { count: 'exact', head: true });
            if (appLimit > 0 && count >= appLimit) {
                alert("ì‹ ì²­ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì œí•œ ì¸ì› ì´ˆê³¼)");
                showLoading(false); return;
            }

            await db.from('applications').delete().match({ affiliation: data.aff, name: data.name, phone: data.tel });

            const { error } = await db.from('applications').insert([{
                affiliation: data.aff, position: data.pos, name: data.name, phone: data.tel, schedule_date: p.date, schedule_time: p.time
            }]);

            if (error) throw error;
            showLoading(false);
            
            let summaryHtml = `
                <div style="line-height:1.6; margin-bottom:10px;">
                    <strong>ì†Œì†:</strong> ${data.aff}<br>
                    <strong>ì´ë¦„:</strong> ${data.name}<br>
                    <strong>ì—°ë½ì²˜:</strong> ${data.tel}
                </div>
                <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
                <strong>[ì‹ ì²­ ì¼ì •]</strong>
                <ul style="margin:5px 0 0 0; padding-left:20px;">
                    <li>${p.date} (${p.time})</li>
                </ul>
            `;
            document.getElementById('resultSummary').innerHTML = summaryHtml;
            document.getElementById('userStep2').classList.remove('active');
            document.getElementById('userStep3').classList.add('active'); 

        } catch (err) {
            showLoading(false); console.error(err); alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    }

    async function checkMyStatus() {
        const aff = document.getElementById('uAff').value; const name = document.getElementById('uName').value; const tel = document.getElementById('uTel').value;
        if(!aff || !name || tel.length < 12) return alert("ì •ë³´ ì…ë ¥ í•„ìš”");
        
        showLoading(true);
        currentUserData = {aff, name, tel};
        
        try {
            const { data } = await db.from('applications').select('*').match({ affiliation: aff, name: name, phone: tel }).single();
            showLoading(false);
            
            if (data) {
                let html = `
                    <div style="text-align:left; line-height:1.8;">
                        <p><strong>[ì‹ ì²­ì ì •ë³´]</strong></p>
                        - ì†Œì†: ${data.affiliation}<br>
                        - ì´ë¦„: ${data.name}<br>
                        - ì ‘ìˆ˜ì¼ì‹œ: ${data.created_at.substring(0,16).replace('T', ' ')}
                        <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
                        <p><strong>[ì‹ ì²­ ë‚´ìš©]</strong></p>
                        <ul><li>${data.schedule_date} (${data.schedule_time})</li></ul>
                    </div>
                `;
                document.getElementById('statusContent').innerHTML = html; 
                document.getElementById('statusModal').classList.add('show'); 
                currentPriorities = [{date: data.schedule_date, time: data.schedule_time}];
            } else {
                alert("ë‚´ì—­ ì—†ìŒ");
            }
        } catch (e) {
            showLoading(false); alert("ë‚´ì—­ ì—†ìŒ");
        }
    }

    function closeStatusModal(){ document.getElementById('statusModal').classList.remove('show'); }
    
    async function editFromStatus() { 
        if(!confirm("ì‹ ì²­ ë§ˆê° ì¸ì› ë°˜ì˜ì— ë”°ë¼ ìˆ˜ì • ì‹ ì²­ì´ ì•ˆë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í™•ì¸ ì‹œ ê¸°ì¡´ ë‚´ì—­ì€ ì¦‰ì‹œ ì‚­ì œë˜ë©° ë‹¤ì‹œ ì‹ ì²­í•´ì•¼ í•©ë‹ˆë‹¤.)")) return;
        closeStatusModal(); showLoading(true);
        
        await db.from('applications').delete().match({ affiliation: currentUserData.aff, name: currentUserData.name, phone: currentUserData.tel });
        
        fetchSettings().then(() => {
            showLoading(false);
            alert("ê¸°ì¡´ ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nì›í•˜ëŠ” ë‚ ì§œë¡œ ë‹¤ì‹œ ì‹ ì²­í•´ì£¼ì„¸ìš”.");
            
            if(currentPriorities.length > 0) {
                const oldDate = currentPriorities[0].date; const oldTime = currentPriorities[0].time;
                document.getElementById('uDate').value = oldDate; document.getElementById('selectedDateDisplay').innerText = `ì„ íƒí•œ ë‚ ì§œ: ${oldDate}`;
                
                const radios = document.getElementsByName('uTime');
                for(let r of radios) { if(r.value === oldTime) r.checked = true; }
                
                const d = new Date(oldDate);
                currentYear = d.getFullYear(); currentMonth = d.getMonth(); renderCalendar(currentYear, currentMonth);
            }
            document.getElementById('userStep1').classList.remove('active'); document.getElementById('userStep2').classList.add('active'); 
        });
    }

    async function cancelMyApplication() {
        if(!confirm("ì •ë§ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì·¨ì†Œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
        closeStatusModal(); showLoading(true);
        
        await db.from('applications').delete().match({ affiliation: currentUserData.aff, name: currentUserData.name, phone: currentUserData.tel });
        
        fetchSettings().then(() => {
            showLoading(false); alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('userStep2').classList.remove('active'); document.getElementById('userStep3').classList.remove('active'); document.getElementById('userStep1').classList.add('active');
        });
    }

    async function toUserStep2() {
        if(!checkAppValidity()) return;
        const aff = document.getElementById('uAff').value.trim(); const name = document.getElementById('uName').value; const tel = document.getElementById('uTel').value;

        if(!aff || !name) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (!aff.endsWith("ì´ˆë“±í•™êµ") && !aff.endsWith("ì¤‘í•™êµ") && !aff.endsWith("ê³ ë“±í•™êµ") && !aff.endsWith("ìœ ì¹˜ì›") && !aff.endsWith("í•™êµ") && !aff.endsWith("êµìœ¡ì›")) {
             return alert("âš ï¸ ì†Œì† ì…ë ¥ ì˜¤ë¥˜\n\n'í•¨í‰ì´ˆë“±í•™êµ'ì™€ ê°™ì´ ì „ì²´ ëª…ì¹­ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
        if(tel.length !== 13) return alert("âš ï¸ ì—°ë½ì²˜ ì…ë ¥ ì˜¤ë¥˜\n\níœ´ëŒ€í° ë²ˆí˜¸ 11ìë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        showLoading(true);
        try {
            const { data } = await db.from('applications').select('*').match({ affiliation: aff, name: name, phone: tel }).single();
            const { count } = await db.from('applications').select('*', { count: 'exact', head: true });
            
            showLoading(false);
            if(data) {
                if (isForceClosed || (appLimit > 0 && count >= appLimit)) { alert("ì‹ ì²­ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤."); return; }
                alert("ì´ë¯¸ ì‹ ì²­ ë‚´ì—­ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\nìˆ˜ì •ì„ ì›í•˜ì‹œë©´ 'ë‚´ì—­ í™•ì¸' í›„ 'ìˆ˜ì •' ë²„íŠ¼ì„ ì´ìš©í•´ì£¼ì„¸ìš”.");
            } else {
                if (isForceClosed || (appLimit > 0 && count >= appLimit)) { alert("ì‹ ì²­ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤."); return; }
                currentPriorities = []; document.getElementById('uDate').value = ""; document.getElementById('selectedDateDisplay').innerText = "";
                const radios = document.getElementsByName('uTime'); for(let r of radios) r.checked = false;
                renderCalendar(currentYear, currentMonth);
                document.getElementById('userStep1').classList.remove('active'); document.getElementById('userStep2').classList.add('active'); 
            }
        } catch (e) {
            showLoading(false); currentPriorities=[]; 
            document.getElementById('userStep1').classList.remove('active'); document.getElementById('userStep2').classList.add('active');
        }
    }

    function toUserStep1(){ document.getElementById('userStep2').classList.remove('active'); document.getElementById('userStep1').classList.add('active'); }
    function resetForm(){location.reload();}
    
    async function editAndResubmit(){ 
        if(!confirm("ì‹ ì²­ ë§ˆê° ì¸ì› ë°˜ì˜ì— ë”°ë¼ ìˆ˜ì • ì‹ ì²­ì´ ì•ˆë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        showLoading(true);
        const aff = document.getElementById('uAff').value; const name = document.getElementById('uName').value; const tel = document.getElementById('uTel').value;
        await db.from('applications').delete().match({ affiliation: aff, name: name, phone: tel });
        
        fetchSettings().then(() => {
            showLoading(false);
            document.getElementById('userStep3').classList.remove('active'); document.getElementById('userStep2').classList.add('active'); 
        });
    }
    
    function openAdminAuth() { 
        const pw = prompt("PW:");
        if(pw === ADMIN_PASSWORD) { 
            adminToken = pw; 
            refreshAdminData(); 
            document.getElementById('userMode').style.display='none'; document.getElementById('adminMode').classList.add('active');
            if(eduRange.start) document.getElementById('adminEduStart').value=eduRange.start; 
            if(eduRange.end) document.getElementById('adminEduEnd').value=eduRange.end;
            if(appRange.start) document.getElementById('adminAppStart').value=appRange.start; 
            if(appRange.end) { document.getElementById('adminAppEnd').value=appRange.end; document.getElementById('adminExtendEnd').value=appRange.end; }
            updateForceCloseUI();
        } else if (pw) { alert("ì‹¤íŒ¨"); }
    }
    function exitAdmin(){ document.getElementById('adminMode').classList.remove('active'); document.getElementById('userMode').style.display='block'; adminToken=""; }
    function switchAdminTab(n){ document.querySelectorAll('.admin-tab-content').forEach(t=>t.style.display='none'); document.getElementById('tab-'+n).style.display='block'; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); }
    
    async function refreshAdminData() {
        if(!adminToken) return;
        showLoading(true);
        const { data: apps } = await db.from('applications').select('*').order('created_at', { ascending: false });
        showLoading(false);
        if(apps) {
            adminDataCache = apps;
            renderAdminTable(apps);
            document.getElementById('adminCount').innerText = apps.length;
        }
    }

    async function adminSaveAppLimit() {
        const val = document.getElementById('adminAppLimit').value;
        if(val === "") return alert("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        showLoading(true);
        await db.from('config').update({ app_limit: val }).eq('id', 1);
        appLimit = val; document.getElementById('adminLimitDisplay').innerText = (val > 0) ? val : "âˆ";
        showLoading(false); alert("ì €ì¥ë¨");
    }

    async function adminSaveTitleInfo() {
        const m = document.getElementById('adminMainTitle').value; const s = document.getElementById('adminSubTitle').value;
        showLoading(true);
        await db.from('config').update({ main_title: m, sub_title: s }).eq('id', 1);
        document.getElementById('mainTitle').innerText = m; document.getElementById('subTitle').innerText = s;
        showLoading(false); alert("ì €ì¥ë¨");
    }

    function renderAdminCalendar() {
        const grid = document.getElementById('adminCalGrid'); grid.innerHTML = "";
        document.getElementById('adminCalMonthYear').innerText = `${adminCalYear}ë…„ ${adminCalMonth + 1}ì›”`;
        const firstDay = new Date(adminCalYear, adminCalMonth, 1).getDay(); const daysInMonth = new Date(adminCalYear, adminCalMonth + 1, 0).getDate(); 
        
        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
        for (let d = 1; d <= daysInMonth; d++) {
            const monthStr = (adminCalMonth + 1).toString().padStart(2, '0'); const dayStr = d.toString().padStart(2, '0');
            const fullDateStr = `${adminCalYear}-${monthStr}-${dayStr}`;
            const cell = document.createElement('div'); cell.className = 'cal-date'; cell.innerText = d;
            
            if(blockedDates.includes(fullDateStr)) { cell.style.backgroundColor = "#f0f0f0"; cell.style.color = "#999"; cell.style.cursor = "not-allowed"; } 
            else {
                if(adminSelectedDates.includes(fullDateStr)) cell.classList.add('admin-selected');
                cell.onclick = function() { toggleAdminDate(fullDateStr); };
            }
            grid.appendChild(cell);
        }
        renderAdminBlockedList();
    }
    
    function toggleAdminDate(dateStr) {
        if(adminSelectedDates.includes(dateStr)) adminSelectedDates = adminSelectedDates.filter(d => d !== dateStr);
        else adminSelectedDates.push(dateStr);
        renderAdminCalendar();
    }
    function prevAdminCal() { adminCalMonth--; if(adminCalMonth < 0) { adminCalMonth = 11; adminCalYear--; } renderAdminCalendar(); }
    function nextAdminCal() { adminCalMonth++; if(adminCalMonth > 11) { adminCalMonth = 0; adminCalYear++; } renderAdminCalendar(); }

    async function adminBlockSelectedDates() {
        if(adminSelectedDates.length === 0) return alert("ì°¨ë‹¨í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        if(!confirm(`ì„ íƒí•œ ${adminSelectedDates.length}ê°œì˜ ë‚ ì§œë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        showLoading(true);
        const inserts = adminSelectedDates.map(d => ({ blocked_date: d }));
        await db.from('blocked_dates').insert(inserts);
        
        adminSelectedDates = []; 
        fetchSettings().then(() => { showLoading(false); alert("ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤."); });
    }

    function toggleAllChecks(source) { const checkboxes = document.querySelectorAll('.row-check'); for(let cb of checkboxes) cb.checked = source.checked; }
    
    async function adminDeleteSelected() {
        const checkboxes = document.querySelectorAll('.row-check:checked');
        if(checkboxes.length === 0) return alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        if(!confirm(`ì„ íƒí•œ ${checkboxes.length}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ ë³µêµ¬ ë¶ˆê°€í•©ë‹ˆë‹¤.`)) return;
        
        showLoading(true);
        for(let cb of checkboxes) {
            await db.from('applications').delete().eq('id', cb.getAttribute('data-id'));
        }
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); refreshAdminData(); fetchSettings(); 
    }

    function adminSaveAppRange(){ saveAppPeriodToServer(document.getElementById('adminAppStart').value, document.getElementById('adminAppEnd').value); }
    function adminResetAppRange(){ if(confirm("ì´ˆê¸°í™”?")) saveAppPeriodToServer("",""); }
    function adminExtendApp(){ saveAppPeriodToServer(document.getElementById('adminAppStart').value||appRange.start, document.getElementById('adminExtendEnd').value); }
    
    async function saveAppPeriodToServer(s,e){ 
        showLoading(true);
        await db.from('config').update({ app_start: s ? s.replace('T', ' ')+':00' : null, app_end: e ? e.replace('T', ' ')+':00' : null }).eq('id', 1);
        appRange={start:s, end:e}; document.getElementById('adminAppStart').value=s; document.getElementById('adminAppEnd').value=e; document.getElementById('adminExtendEnd').value=e; 
        updateStatusIndicator(); showLoading(false); alert("ì €ì¥ë¨");
    }

    function updateForceCloseUI(){ 
        const txt=document.getElementById('forceStatusText'), btnC=document.getElementById('btnForceClose'), btnO=document.getElementById('btnForceOpen');
        if(isForceClosed){ txt.innerHTML="<b style='color:red'>ë§ˆê°ë¨</b>"; btnC.style.display='none'; btnO.style.display='inline-block'; }
        else{ txt.innerHTML="<b style='color:green'>ì‹ ì²­ ê°€ëŠ¥</b>"; btnC.style.display='inline-block'; btnO.style.display='none'; }
    }
    async function toggleForceClose(c){ 
        if(confirm("ë³€ê²½?")){ 
            showLoading(true); 
            await db.from('config').update({ is_force_closed: c }).eq('id', 1);
            isForceClosed=c; updateForceCloseUI(); updateStatusIndicator(); showLoading(false);
        } 
    }
    
    async function adminSaveEduRange(){ 
        const s=document.getElementById('adminEduStart').value, e=document.getElementById('adminEduEnd').value; 
        showLoading(true); 
        await db.from('config').update({ edu_start: s, edu_end: e }).eq('id', 1);
        eduRange={start:s, end:e}; showLoading(false); alert("ì €ì¥ë¨");
    }
    
    function renderAdminTable(rows){ 
        const t = document.querySelector('#adminTable tbody');
        if(rows.length===0){ t.innerHTML='<tr><td colspan="7">ì‹ ì²­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
        t.innerHTML = rows.map((r,i) => `
            <tr>
                <td><input type="checkbox" class="row-check" data-id="${r.id}"></td>
                <td>${rows.length - i}</td>
                <td>${r.created_at.substring(0,16).replace('T', ' ')}</td>
                <td>${r.name}</td>
                <td>${r.affiliation}</td>
                <td>${r.phone}</td>
                <td>${r.schedule_date} (${r.schedule_time})</td>
            </tr>
        `).join(''); 
    }

    function renderAdminBlockedList(){ 
        document.getElementById('adminBlockedList').innerHTML = blockedDates.map(d => `<span class="blocked-tag">${d} <button onclick="adminRemoveBlock('${d}')">x</button></span>`).join('');
    }

    function downloadExcel(){ 
        if(adminDataCache.length===0) return alert("ì—†ìŒ"); 
        const ws = XLSX.utils.json_to_sheet(adminDataCache.map((r,i)=>({
            'No': adminDataCache.length - i,
            'ì ‘ìˆ˜ì¼ì‹œ': r.created_at.substring(0,16).replace('T', ' '),
            'ì†Œì†': r.affiliation,
            'ì´ë¦„': r.name,
            'ì—°ë½ì²˜': r.phone,
            'ì‹ ì²­ì¼ì •': `${r.schedule_date} (${r.schedule_time})`
        })));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "List"); XLSX.writeFile(wb, "List.xlsx"); 
    }
    
    async function adminAddHolidays() {
        const y = document.getElementById('holidayYear').value;
        if(!confirm(`${y}ë…„ ê³µíœ´ì¼ì„ ì¼ê´„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        const holidays = HOLIDAY_DB[y] ? Object.keys(HOLIDAY_DB[y]) : [];
        if(holidays.length === 0) return alert("í•´ë‹¹ ì—°ë„ì˜ ê³µíœ´ì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        showLoading(true);
        const inserts = holidays.map(d => ({ blocked_date: d }));
        await db.from('blocked_dates').insert(inserts).select().catch(e=>console.log(e)); 
        
        fetchSettings().then(() => { showLoading(false); alert("ë“±ë¡ ì™„ë£Œ"); });
    }

    async function adminClearAllBlocks() {
        if(!confirm("ëª¨ë“  ì°¨ë‹¨ ë‚ ì§œ ì‚­ì œ?")) return;
        showLoading(true);
        await db.from('blocked_dates').delete().neq('blocked_date', '1900-01-01'); 
        fetchSettings().then(() => { showLoading(false); alert("í•´ì œë¨"); });
    }

    async function adminRemoveBlock(date) {
        if(confirm(date + " í•´ì œ?")) { 
            showLoading(true);
            await db.from('blocked_dates').delete().eq('blocked_date', date);
            fetchSettings().then(() => { showLoading(false); });
        }
    }

    function autoHyphen(target) {
        target.value = target.value.replace(/[^0-9]/g, '').replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g, "$1-$2-$3").replace(/(\-{1,2})$/g, "");
    }
</script>
